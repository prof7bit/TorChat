<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <title>
   Howto: Run more than one instance of TorChat
  </title>
 </head>
 <body>
  <h1>
   How to run more than on instance of TorChat
  </h1>
  <p>
   First I will explain how torchat.ini and portable mode are working and
   where all relevant data files are located. The most important things are
   <ul>
    <li><code>portable.txt</code></li>
    <li>torchat.ini</li>
    <li>the folder Tor</li>
   </ul>
   Then I will explain some things about adresses and port numbers of the 
   client and the tor proxy. You should fully understand this before you go on
   to the last section where we actually move files around and change some 
   of the settings.
  </p>
  <p>
   Most of the this document is primarily targeted towards users of Microsoft
   Windows, because Windows is by far the most complicated operating system
   in existence. Users of Unix/Linux based operating systems can easily adopt
   all the information here for their platforms without problems.
  </p>
  <h2>
   portable mode or fixed installation
  </h2>
   <p>
    <b>Full Portable Mode</b> means that all that is needed is contained in one folder
    which you can carry around on an usb drive and run it wherever you
    happen to be. Therefore TorChat comes bundled with its own tor.exe
    which it will try to start and all settings and data files remain inside
    this folder. Nothing will be copied or installed outside this folder
    to the computer's hard drive. Full Portable Mode is currently only available
    for the Windows version of TorChat and the windows version you can download 
    is already preconfigured for Full Portable Mode out of the box.
   </p>
   <p>
    There is a second form of the portable mode, the <b>Half Portable Mode</b> 
    which is much like the first one except that it uses an already existing 
    tor service on your computer or somewhere in your local network. This mode 
    is useful if you want to run more than one instance of torchat over the 
    same (already existing) tor proxy
   </p>  
   <p>
    Finally there is the <b>Permanent Installation</b>. TorChat can be installed 
    to a read-only folder like c:\programs\ or /usr/* and all of it's data and
    configuration will be in %APPDATA%\torchat\ or ~/.torchat/
   </p>  
   <p>
    The next few sections will explain how the mode is selected and how
    this is related to the configuration files.
   </p>  
  <h3>
   portable.txt
  </h3>
  <p>
   There is a file called portable.txt. It's contents are completely
   irrelevant, in fact it could be empty, only it's <b>existance is an
   indicator</b> wether TorChat should run in portable mode or not. If you delete
   this file, TorChat will store all it's data like the buddy-list and the
   configuration file in the user's <b>home directory</b> and it will not even 
   try to start the Tor\tor.exe, you must then have a separate
   tor service already running on this machine or somewhere in your network
   and tell TorChat via torchat.ini about your tor installation. 
   If there is a file called portable.txt TorChat will look for all
   it's configuration and data in the same folder where torchat.exe 
   (or .py on *ix systems) is located and try to start tor\tor.exe
  </p>
  <h3>
   torchat.ini
  </h3>
  <p>
   Depending on wether the portable.txt is found or not TorChat
   will look for torchat.ini in the current directory or in the
   user's home directory. torchat.ini contains two sections
   <b>[tor]</b> and <b>[tor_portable]</b>. Only if we are in portable mode
   (portable.txt) <b>and</b> TorChat was able to successfully start the
   bundled Tor\tor.exe we are in Full Portable Mode, 
   and the section [tor_portable] is used, in all other cases 
   (Half Portable or Permanent Installation) the settings in [tor] are used.
  </p>
  <h3>
   The folder Tor
  </h3>
  <p>
   If we are in portable mode (portable.txt) TorChat will <b>try</b> to start
   Tor\tor.exe with the tor configuration in Tor\torrc.txt.
   If this all succeeds we are in <b>Full Portable Mode</b>.
   It is perfectly ok to have a portable.txt but no Tor\tor.exe.
   In this case all configuration and data files are kept in the installation
   folder (which then must be writeable of course) and still an already existing
   tor service can be used (<b>Half Portable Mode</b>). 
  </p>
  <h3>
   Summary
  </h3>
  <p>
   The whole thing could also be explained by some piece of pseudo-code:
   <pre>
     if found portable.txt:
         -> Portable Mode
         -> use current folder for all data
         if can start tor.exe:
             -> Full Portable Mode
             -> use settings in [tor_portable]
         else:
             -> Half portable Mode
             ->use settings in [tor]
     else:
         -> Permanent Installation
         -> use home folder for all data
         -> use settings in [tor]
   </pre>
   </p>
   <p>
   	or if you are more attracted to tables we can summarize it in a tabular way:
   </p>
   <table border="1">
    <tr>
     <th>portable.txt</th>
     <th>Tor/tor.exe</th>
     <th>what will happen</th>
    </tr>
    <tr>
     <td>present</td>
     <td>present and working</td>
     <td><b>Full Portable Mode</b><br />
      all data and config in installation folder<br />
      settings in [tor_portable] are used</td>
    </tr>
    <tr>
     <td>present</td>
     <td>not present or not working</td>
     <td><b>Half Portable Mode</b><br />
      all data and config in installation folder<br />
      settings in [tor] are used</td>
    </tr>
    <tr>
     <td>-</td>
     <td>no matter</td>
     <td><b>Permanent Installation</b><br />
      all data and config in home folder (~/.torchat or %APPDATA%\torchat)<br />
      settings in [tor] are used</td>
    </tr>
   </table>
  </p>
  <h2>
   The configuration of Tor
  </h2>
  <h3>
   Full Portable Mode
  </h3>
  <p>
   In Full Portable Mode normally you don't have to configure anything. The
   tor binary which is bundled with TorChat will be started with /Tor/torrc.txt
   as it's configuration file. Out of the box it is configured to listen on
   port 11109 (socks) and port 11119 (control) and to forward the hidden 
   service port 11009 to localhost:11009. Note that this are the same
   port numbers as configured in torchat.ini section [tor_portable]
  </p>
  <p>
   The hidden service directory in Full Portable Mode is hidden_service
   inside the Tor folder. You may not change this.
  </p> 
  <p>
   If you plan to run a second Full Portable instance on the same computer
   you will have to change all this port numbers and also the corresponding
   settings in torchat.ini section [tor_portable] and [client] in the
   <b>second copy</b> of the whole torchat folder.
  </p>
  <h3>
   Half Portable and Permanent Installation
  </h3>
  <p>
   You need to configure a hidden service in your existing tor installation.
   To do this simply create a folder somewhere on your harddisk.
   For simplicity we just assume the full path to this folder is 
   <pre>
   c:\foo\bar\onion1
   </pre>
   put the following lines into your torrc:
   <pre>
   HiddenServiceDir c:\foo\bar\onion1
   HiddenServicePort 11009 localhost:11009
   </pre>
   Now restart your tor service, make sure it runs without errors. While tor is
   now running again in the background as normal, have a look into our hidden
   service folder we just created. There should be two files (which have been
   created by tor). One is named <b>private_key</b> and one is named <b>hostname</b>.
   Inside this file (open it with notepad) you will find your <b>.onion address</b>.
   It will be something like <b>16crypticletters.onion</b>. Later on in this 
   document i will refer to this 16 cryptic letters as your .onion address.
  </p>
  <p>
   Note: In the example above we have forwarded the hidden service 11009 to the
   <b>local</b> address localhost, port 11009. The <b>first</b> 11009 is the port
   "inside" the tor network, never change this.
  </p>
  <h2>
   The configuration of TorChat
  </h2>
  <p>
   Torchat ist configured with torchat.ini. Where this file is located depends
   on the mode (portable or permanent, see above). Two sections in this 
   configuration file are of interest here: [tor] and [client]. If you use
   the Full Portable Mode it is [tor_portable] instead of [tor], all the rest 
   stays the same.
  </p>
  <p>
   The options in [tor] or [tor_portable] tell TorChat how to reach your 
   tor proxy. They must be identical to SocksPort and ControlPort in the
   torrc of your tor installation.
  </p>
  <p>
   The options in [client] tell TorChat where to listen for incoming
   connections. They correspond to the last part of the HiddenServicePort
   setting in your torrc.
  </p>
 </body>
</html>
